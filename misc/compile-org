#!/usr/bin/env python3
import sys
import tempfile
from subprocess import check_call
from pathlib import Path


# This is necessary because otherwise emacs loads default outdated org-mode (e.g. in /usr/share) in batch mode
def get_org_plus_path() -> Path:
    pp = Path('~/.emacs.d/elpa/').expanduser()
    matches = list(pp.glob('*/*/org-plus-contrib-*/'))
    assert len(matches) == 1
    return matches[0]


def filter_private(data: str) -> str:
    lines = [l for l in data.splitlines() if 'NOEXPORT' not in l]
    return '\n'.join(lines)


def main():
    org_data = sys.stdin.read()
    with tempfile.TemporaryDirectory() as td:
        td = Path(td)

        org_data = filter_private(org_data)

        inp_org  = td / 'input.org'
        inp_org.write_text(org_data)


        out_html = td / 'output.html'

        # TODO make sure it propagates errors properly...
        check_call([
            'emacs',
            '--kill',
            '--batch',
            '--directory', str(get_org_plus_path()),
            str(inp_org),
            '--eval', f'''(progn
; TODO ok, so maybe do not export CREATED property, but show it as a tooltip?
; TODO hmm. find another way to configure these...
; TODO use STRT?
(setq org-todo-keywords '((sequence "TODO" "START" "DONE")))

(defun org-export-deterministic-reference (references)
  (let ((new 0))
    (while (rassq new references) (setq new (+ new 1))) ; TODO shit, quadratic time! perhaps start with max??
    new))
(advice-add #'org-export-new-reference :override #'org-export-deterministic-reference)

(setq org-time-stamp-custom-formats
       '("[%Y-%m-%d]" . "[%Y-%m-%d %H:%M]"))

(setq org-display-custom-times 't)

(org-html-export-as-html nil nil nil t)
; t is for BODY-ONLY
(write-file "{str(out_html)}")

            )'''
        ])
        sys.stdout.write(out_html.read_text())

if __name__ == '__main__':
    main()
